---
title: "스레드풀 관련 장애"
excerpt: "스레드풀 관련 장애"

categories:
  - diary
tags:
  - tag1

permalink: /diary/4th/

toc: true
toc_sticky: true

date: 2024-12-03
last_modified_at: 2024-12-08
---

## 스레드풀 관련 장애
1~2분 정도 메신저 서버가 멈추는 장애가 발생했다.  
급격히 발생했기 때문인지 모니터링 툴에는 아무런 전조도 보이지않고 장애 시간대의 지표는 전혀 수집되지 않았다.  
유일한 변화는 장애 해소 이후의 특정 스레드의 개수가 장애발생 전보다 늘어난 것.  
웹소켓 메세지를 전송하는 서버의 응답시간이 밀렸던 것이 확인되어 해당 서버의 heap 사이즈를 늘리는 것으로 조치가 되었다.  
그렇지만 웹소켓 서버가 느려졌다고해서 메신저 서버가 멈춘다는게 이상했고, 스레드 관련 로직을 확인한 결과   
각 db shard에서 Future로 데이터를 가져와 합치는 조회 로직과  
비동기로 websocket 메세지를 보내는 로직이 둘다 @Async 어노테이션 사용하여 같은 스레드풀을 공유하고있었다.  
해당 사항을 공유하고 분리조치를 했으며 같은 현상이 발생했을 때 웹소켓 메세지만 늦어질 것으로 기대한다.   
@Asyc 어노테이션 사용할 떄 어떤 taskExecutor를 사용하는지 무조건 기입하면 검색도 쉽고 의도치않은 공유도 막을 수 있지 않을까? 라는 생각을 해본다.




